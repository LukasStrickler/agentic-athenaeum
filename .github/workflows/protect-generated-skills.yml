name: Protect Generated Skills

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review, edited]

permissions:
  contents: read
  pull-requests: read

jobs:
  protect-generated-skills:
    runs-on: ubuntu-latest
    steps:
      - name: Block unauthorized skills/ changes
        uses: actions/github-script@v7
        env:
          RELEASE_TRUSTED_ACTORS: ${{ vars.RELEASE_TRUSTED_ACTORS }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number,
              per_page: 100,
            });

            const changedSkillsFiles = files
              .filter((file) => file.filename.startsWith("skills/"))
              .map((file) => file.filename);

            const misplacedSkillMdFiles = files
              .map((file) => file.filename)
              .filter((filename) => {
                const normalizedPath = filename.toLowerCase();

                if (normalizedPath.startsWith("skills/")) {
                  return false;
                }

                const basename = normalizedPath.split("/").pop();
                return basename === "skill.md" || basename === "skills.md";
              });

            if (misplacedSkillMdFiles.length > 0) {
              core.setFailed(
                [
                  "Misplaced skill descriptor files are blocked in PRs.",
                  "SKILL.md and Skills.md are only allowed under skills/.",
                  "Rename source descriptors to SKILL.dev.md in dev/<skill>/.",
                  "",
                  "Offending files:",
                  ...misplacedSkillMdFiles.map((name) => `- ${name}`),
                ].join("\n")
              );
              return;
            }

            if (changedSkillsFiles.length === 0) {
              core.info("No changes in skills/. Guard check passed.");
              return;
            }

            const headRef = context.payload.pull_request.head.ref;
            const pullRequestAuthor = context.payload.pull_request.user.login;
            const sameRepo =
              context.payload.pull_request.head.repo.full_name === `${owner}/${repo}`;
            const releaseBranchPattern = /^automation\/release-generated-v(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)\.(0|[1-9][0-9]*)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?$/;
            const releaseBranch = releaseBranchPattern.test(headRef);

            const configuredTrustedActors = (process.env.RELEASE_TRUSTED_ACTORS || "")
              .split(",")
              .map((actor) => actor.trim())
              .filter(Boolean);
            const trustedActors = new Set([
              "github-actions[bot]",
              "app/agentic-athenaeum-release-bot",
              ...configuredTrustedActors,
            ]);
            const trustedActor =
              trustedActors.has(pullRequestAuthor) || trustedActors.has(context.actor);

            if (sameRepo && releaseBranch && trustedActor) {
              core.notice(
                `Allowing skills/ changes from trusted release branch ${headRef}.`
              );
              return;
            }

            core.setFailed(
              [
                "Changes to skills/ are blocked in normal PRs.",
                "Edit sources in dev/ only. skills/ is generated by the release workflow.",
                "",
                "Changed generated files:",
                ...changedSkillsFiles.map((name) => `- ${name}`),
                "",
                "If this is a release update, use workflow_dispatch on release.yml with mode=prepare.",
                "Optional: set repository variable RELEASE_TRUSTED_ACTORS for additional trusted bot logins.",
              ].join("\n")
            );
